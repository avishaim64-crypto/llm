import requests
import json
import time


def test_summarizer_service(params=None):
    """×‘×“×™×§×ª ×©×™×¨×•×ª ×”×ª×§×¦×•×¨"""

    url = "http://localhost:8000/summarize"

    # ×˜×§×¡×˜ ×œ×“×•×’××” ×‘×¢×‘×¨×™×ª
    hebrew_text = """
    ×™×¨×•×©×œ×™× ×”×™× ××—×ª ×”×¢×¨×™× ×”×¢×ª×™×§×•×ª ×•×”××©××¢×•×ª×™×•×ª ×‘×¢×•×œ×, ×•×¢×•××“×ª ×‘××¨×›×– ×”×”×™×¡×˜×•×¨×™×” ×”×“×ª×™×ª, ×”×ª×¨×‘×•×ª×™×ª ×•×”×¤×•×œ×™×˜×™×ª ×©×œ ×”××–×¨×— ×”×ª×™×›×•×Ÿ ×›×‘×¨ ××œ×¤×™ ×©× ×™×. ×¨××©×™×ª×” ×›×™×™×©×•×‘ ××ª×•××¨×›×ª ×œ×ª×§×•×¤×ª ×”×‘×¨×•× ×–×” ×”××•×§×“××ª, ×‘×¡×‘×™×‘×•×ª ×”××œ×£ ×”×¨×‘×™×¢×™ ×œ×¤× ×”×´×¡. ×‘××§×¨× × ×–×›×¨×ª ×™×¨×•×©×œ×™× ×›×¢×™×¨ ×”×™×‘×•×¡×™×, ×¢×“ ×œ×›×™×‘×•×©×” ×‘×™×“×™ ×“×•×“ ×”××œ×š ×‘×××” ×”Ö¾10 ×œ×¤× ×”×´×¡, ××– ×”×¤×›×” ×œ×‘×™×¨×ª ×××œ×›×ª ×™×©×¨××œ ×”×××•×—×“×ª. ×©×œ××”, ×‘× ×• ×©×œ ×“×•×“, ×‘× ×” ××ª ×‘×™×ª ×”××§×“×© ×”×¨××©×•×Ÿ, ×©×”×™×•×•×” ××•×§×“ ×¤×•×œ×—× ×™ ×•×¨×•×—× ×™ ××¨×›×–×™ ×œ×¢× ×”×™×”×•×“×™.

×œ××•×¨×š ×”×“×•×¨×•×ª, ×™×¨×•×©×œ×™× × ×›×‘×©×” ×¤×¢××™× ×¨×‘×•×ª. ×‘×©× ×ª 586 ×œ×¤× ×”×´×¡ ×—×¨×‘ ×‘×™×ª ×”××§×“×© ×”×¨××©×•×Ÿ ×‘×™×“×™ × ×‘×•×›×“× ××¦×¨ ××œ×š ×‘×‘×œ, ×•×”×¢×™×¨ ×¢×‘×¨×” ×ª×—×ª ×©×œ×˜×•×Ÿ ×‘×‘×œ×™ ×•×œ××—×¨ ××›×Ÿ ×¤×¨×¡×™. ×¢× ×›×™×‘×•×©×™ ××œ×›×¡× ×“×¨ ××•×§×“×•×Ÿ ×‘×××” ×”Ö¾4 ×œ×¤× ×”×´×¡ × ×›× ×¡×” ×ª×—×ª ×”×©×¤×¢×” ×”×œ× ×™×¡×˜×™×ª. ×‘×©× ×ª 63 ×œ×¤× ×”×´×¡ × ×›×‘×©×” ×‘×™×“×™ ×¤×•××¤×™×•×¡ ×”×¨×•××™, ×•×œ××—×¨ ××›×Ÿ ×”×™×™×ª×” ×œ×—×œ×§ ××”××™××¤×¨×™×” ×”×¨×•××™×ª. ×‘×©× ×ª 70 ×œ×¡×¤×™×¨×” ×—×¨×‘ ×‘×™×ª ×”××§×“×© ×”×©× ×™ ×‘××¨×“ ×”×’×“×•×œ, ××™×¨×•×¢ ×©×¢×™×¦×‘ ××ª ×–×”×•×ª ×”×¢× ×”×™×”×•×“×™ ×œ×“×•×¨×•×ª. ×‘×”××©×š, ×‘×××” ×”Ö¾2 ×œ×¡×¤×™×¨×”, × ×‘× ×ª×” "××œ×™×” ×§×¤×™×˜×•×œ×™× ×”" ×¢×œ ×—×•×¨×‘×•×ª ×”×¢×™×¨, ×•× ××¡×¨×” ×™×©×™×‘×ª ×™×”×•×“×™× ×‘×”.

×¢× ×”×ª×¤×©×˜×•×ª ×”××¡×œ×× ×‘×××” ×”Ö¾7 × ×›×‘×©×” ×™×¨×•×©×œ×™× ×‘×™×“×™ ×”×—×³×œ×™×£ ×¢×•××¨, ×•× ×‘× ×• ×‘×” ×›×™×¤×ª ×”×¡×œ×¢ ×•××¡×’×“ ××œÖ¾××§×¦×, ×©×”×¤×›×• ××ª ×”×¢×™×¨ ×œ××ª×¨ ×§×“×•×© ×’× ×œ××•×¡×œ××™×. ×‘×××” ×”Ö¾11 × ×›×‘×©×” ×‘×™×“×™ ×”×¦×œ×‘× ×™×, ×©×©×œ×˜×• ×‘×” ×¢×“ ×—×–×¨×ª ×¦×œ××— ×Ö¾×“×™×Ÿ ×‘×©× ×ª 1187. ×‘×ª×§×•×¤×” ×”×¢×•×ª×³××× ×™×ª, ×©×”×—×œ×” ×‘×××” ×”Ö¾16, × ×‘× ×• ×—×•××•×ª ×”×¢×™×¨ ×”××•×›×¨×•×ª ×œ× ×• ×›×™×•×.

×‘×××” ×”Ö¾19 ×”×—×œ×” ×™×¨×•×©×œ×™× ×œ×”×ª×¤×ª×— ××—×“×© ×›××¨×›×– ×‘×™× ×œ××•××™, ×¢× ×§×”×™×œ×•×ª × ×•×¦×¨×™×•×ª, ××•×¡×œ××™×•×ª ×•×™×”×•×“×™×•×ª ×©×’×“×œ×• ××—×•×¥ ×œ×—×•××•×ª. ×‘×ª×§×•×¤×ª ×”×× ×“×˜ ×”×‘×¨×™×˜×™ (1917â€“1948) ×”×¤×›×” ×œ××•×§×“ ××ª×™×—×•×ª ×‘×™×Ÿ ×™×”×•×“×™× ×œ×¢×¨×‘×™×. ×¢× ×§×•× ××“×™× ×ª ×™×©×¨××œ × ×§×‘×¢×” ×›×‘×™×¨×ª×”, ××£ ×›×™ ×”×¢×™×¨ ×—×•×œ×§×” ×¢×“ 1967, ××– ××•×—×“×” ×œ××—×¨ ××œ×—××ª ×©×©×ª ×”×™××™×.

×›×™×•× ×™×¨×•×©×œ×™× ×”×™× ×¢×™×¨ ××•×“×¨× ×™×ª ×•×ª×•×¡×¡×ª, ×”××©×œ×‘×ª ×”×™×¡×˜×•×¨×™×” ×¢×ª×™×§×” ×¢× ×—×™×™× ×¢×›×©×•×•×™×™×, ×•××©××©×ª ××•×§×“ ×¢×œ×™×™×” ×œ×¨×’×œ ×œ×©×œ×•×© ×”×“×ª×•×ª ×”××•× ×•×ª××™×¡×˜×™×•×ª ×”×’×“×•×œ×•×ª
    """

    data = {
        "text": hebrew_text,
        "max_summary_points": 5,
        "temperature": 0.7,
        "top_p": 0.9,
        "max_tokens": 500,
    }

    if params:
        data.update(params)

    print("ğŸš€ ×©×•×œ×— ×‘×§×©×” ×œ×©×™×¨×•×ª ×”×ª×§×¦×•×¨...")
    print(f"ğŸ“ ×˜×§×¡×˜ ××§×•×¨×™: {hebrew_text[:100]}...")
    print("-" * 60)

    try:
        response = requests.post(
            url,
            json=data,
            stream=True,
            headers={
                "Accept": "text/event-stream",
                "Cache-Control": "no-cache",
                "Connection": "keep-alive"
            },
            timeout=120
        )

        if response.status_code != 200:
            print(f"âŒ ×©×’×™××” ×‘×©×™×¨×•×ª: {response.status_code}")
            print(response.text)
            return
        
        

        print(f"(×–××Ÿ: {time.strftime('%H:%M:%S', time.localtime())})")
        print("ğŸ“¡ ××§×‘×œ ×ª×’×•×‘×•×ª ×‘×–××Ÿ ×××ª:")
        print("=" * 40)

        buffer = ""
        point_counter = 0

        # ×”×’×“×œ× ×• chunk_size ×œÖ¾1024 ×›×“×™ ×œ×§×¨×•× ×‘×‘×ª ××—×ª ×™×•×ª×¨ ×ª×•×•×™×
        for chunk in response.iter_content(chunk_size=1024, decode_unicode=True):
            if not chunk:
                continue

            buffer += chunk

            # × ×‘×“×•×§ ×× ×™×© ×œ×¤×—×•×ª ×§×˜×¢ SSE ×©×œ× (××•×¤×¨×“ ×‘Ö¾\n\n)
            while '\n\n' in buffer:
                part, buffer = buffer.split('\n\n', 1)

                # ×—×œ×§ ×™×›×•×œ ×œ×”×›×™×œ ×›××” ×©×•×¨×•×ª, × ×¤×¨×§ ××•×ª×Ÿ
                for line in part.splitlines():
                    if not line.startswith('data: '):
                        continue
                    data_json = line[6:]
                    try:
                        data = json.loads(data_json)

                        # ×¡×˜×˜×•×¡×™× ×›×œ×œ×™×™×
                        if 'status' in data:
                            print(f"â„¹ï¸  ×¡×˜×˜×•×¡: {data['status']}", flush=True)

                        # × ×§×•×“×•×ª ×ª×§×¦×™×¨
                        elif 'summary_point' in data:
                            point = data['summary_point']
                            point_counter += 1
                            print(f"\nğŸ“‹ × ×§×•×“×” {point['point_number']}:", flush=True)
                            print(f"   {point['content']}", flush=True)
                            print(f"   (×–××Ÿ: {time.strftime('%H:%M:%S', time.localtime(point['timestamp']))})",
                                  flush=True)

                        elif 'summary_point_hebrew' in data:
                            final_he = data['summary_point_hebrew']
                            print('', flush=True)  # ×¡×™×•× ×©×•×¨×”
                            print(f"ğŸŸ¦ ×ª×¨×’×•× ×œ×¢×‘×¨×™×ª ×œ× ×§×•×“×” {final_he['point_number']}: {final_he['content']}", flush=True)

                        # ×¡×™×•× ×”×ª×§×¦×™×¨
                        elif data.get('status') == 'completed':
                            print(f"\nâœ… ×”×•×©×œ×! ×¡×š ×”×›×œ {data.get('total_points', 0)} × ×§×•×“×•×ª", flush=True)
                            break

                        # ×©×’×™××”
                        elif 'error' in data:
                            print(f"âŒ ×©×’×™××”: {data['error']}", flush=True)
                            break

                    except json.JSONDecodeError as e:
                        print(f"âš ï¸  ×©×’×™××” ×‘×¤×¢× ×•×— JSON: {e}", flush=True)
                        continue

        print("\n" + "=" * 60)
        print(f"ğŸ ×¡×™×•× - ×”×ª×§×‘×œ×• {point_counter} × ×§×•×“×•×ª ×ª×§×¦×™×¨")

    except requests.exceptions.RequestException as e:
        print(f"âŒ ×©×’×™××ª ×—×™×‘×•×¨: {e}")
        print("ğŸ’¡ ×•×“× ×©×”×©×™×¨×•×ª ×¨×¥ ×¢×œ http://localhost:8000")


def test_health_check():
    """×‘×“×™×§×ª ×ª×§×™× ×•×ª ×”×©×™×¨×•×ª"""
    print("ğŸ¥ ×‘×•×“×§ ×ª×§×™× ×•×ª ×”×©×™×¨×•×ª...")

    try:
        response = requests.get("http://localhost:8000/health", timeout=10)

        if response.status_code == 200:
            health_data = response.json()
            print("âœ… ×”×©×™×¨×•×ª ×ª×§×™×Ÿ")
            print(f"ğŸ“Š ×¡×˜×˜×•×¡ ×©×™×¨×•×ª×™×:")
            for service, status in health_data.get('services', {}).items():
                emoji = "âœ…" if status else "âŒ"
                print(f"   {emoji} {service}: {status}")
        else:
            print(f"âŒ ×”×©×™×¨×•×ª ×œ× ×ª×§×™×Ÿ (×¡×˜×˜×•×¡: {response.status_code})")

    except requests.exceptions.RequestException as e:
        print(f"âŒ ×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ×©×™×¨×•×ª: {e}")


if __name__ == "__main__":
    print("ğŸ§ª ××ª×—×™×œ ×‘×“×™×§×ª ×©×™×¨×•×ª ×ª×§×¦×•×¨ ×˜×§×¡×˜×™×")
    print("=" * 60)

    # ×ª×—×™×œ×” ×‘×“×™×§×ª ×ª×§×™× ×•×ª
    test_health_check()
    print()

    # ×”×“×’××•×ª ×©×•× ×•×ª ×©×œ ×¤×¨××˜×¨×™×
    scenarios = [
        {"name": "×‘×¨×™×¨×ª ××—×“×œ", "params": {}},
        {"name": "×× ×•×ª×§ ×§×©×¨", "params": {"temperature": 1.5, "top_p": 1}},
        #{"name": "×˜××¤×¨×˜×•×¨×” ×’×‘×•×”×”", "params": {"temperature": 1.0}},
        #{"name": "×˜××¤×¨×˜×•×¨×” × ××•×›×”", "params": {"temperature": 0.2}},
        #{"name": "top_p ×’×‘×•×”", "params": {"top_p": 1}},
        #{"name": "××’×‘×œ×ª ×˜×•×§× ×™× ×§×˜× ×”", "params": {"max_tokens": 150}},
    ]

    for s in scenarios:
        print("\n" + "-" * 60)
        print(f"ğŸ”§ ×ª×¨×—×™×©: {s['name']}")
        test_summarizer_service(params=s["params"])
